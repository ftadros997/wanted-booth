<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wanted Poster Booth</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#d7c49e">
<style>
  body{margin:0;font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;background:#f6f0e3;color:#222;}
  header{padding:16px;background:#f6f0e3;border-bottom:1px solid #decfae;}
  .container{max-width:1000px;margin:auto;padding:16px;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
  @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.1);}
  canvas{width:100%;max-width:480px;border:3px solid #654321;border-radius:8px;background:#efe2c4;}
  video{width:100%;max-width:480px;border-radius:8px;background:#000}
  button,.btn{padding:10px 14px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer;font-weight:600;}
  button.secondary{background:#fff;color:#222;border:1px solid #aaa;}
  input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #bbb;width:100%;max-width:300px;}
  input[type=file]{display:none}
  .file-label{display:inline-block;padding:10px 14px;border-radius:8px;border:1px dashed #a97c4a;background:#f7f1e3;cursor:pointer;}
  .row{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0;align-items:center}
  .hint{font-size:.9rem;color:#6b5a46}
</style>
</head>
<body>
<header><div class="container"><h2>Wanted Poster Booth</h2></div></header>

<div class="container grid">
<section class="card">
  <h3>Create your poster</h3>
  <div class="row">
    <label for="name">Name:</label>
    <input id="name" type="text" placeholder="e.g. Sheriff Alex" maxlength="40">
  </div>

  <div class="row">
    <label for="file" id="fileLabel" class="file-label">ðŸ“· Upload Photo</label>
    <!-- IMPORTANT: no capture attribute so iPhone shows Upload / Take Photo / Browse -->
    <input id="file" type="file" accept="image/*">
    <button id="cameraBtn">Use Live Camera</button>
    <button id="snapBtn" class="secondary" disabled>Snap Photo</button>
  </div>
  <div class="row hint">If Snap Photo is disabled, tap <b>Use Live Camera</b> to allow access first.</div>
  <div id="videoWrap" style="display:none"><video id="video" autoplay playsinline></video></div>

  <div class="row">
    <label for="zoom">Zoom:</label>
    <input id="zoom" type="range" min="0.6" max="1.4" step="0.01" value="1.00">
    <span id="zoomVal" class="hint">1.00Ã—</span>
  </div>

  <div class="row">
    <button id="makeBtn">Make Poster</button>
    <a id="dl" class="btn" style="display:none" download="wanted-poster.png">Download Poster</a>
  </div>
  <div class="row hint">Tip: For iPhone live camera, host over HTTPS (GitHub Pages). Upload works anywhere.</div>
</section>

<section class="card"><canvas id="c" width="768" height="1152" aria-label="Wanted poster preview"></canvas></section>
</div>

<script>
const cvs=document.getElementById('c'),ctx=cvs.getContext('2d');
const tpl=new Image();tpl.src='poster_template.png';
let userImg=null,stream=null,hasPhoto=false,imageScale=1.0;

const fileEl=document.getElementById('file'),fileLbl=document.getElementById('fileLabel');
const cameraBtn=document.getElementById('cameraBtn'),snapBtn=document.getElementById('snapBtn');
const video=document.getElementById('video'),videoWrap=document.getElementById('videoWrap');
const makeBtn=document.getElementById('makeBtn'),dl=document.getElementById('dl'),nameEl=document.getElementById('name');
const zoom=document.getElementById('zoom'),zoomVal=document.getElementById('zoomVal');

const crimes=["Stole all the 3 AM burritos","Refused to share fries","Serial high-fiver","Guilty of excessive dad jokes","Pocketed the last donut","Liberating cake from a tiny box","Hijacked the office stapler","Dance-floor instigator","Coffee-cup thief","Snuck extra napkins"];
const rewards=["A bag of gold coins","A lifetime supply of tacos","A golden sheriff badge","Free donuts for a week","A mug of strong coffee","A comfy cowboy hat","Two front-row rodeo seats"];

function pick(a){return a[Math.floor(Math.random()*a.length)];}
function setPhotoChosen(on){hasPhoto=!!on;fileLbl.textContent=on?"ðŸ“· Change Photo":"ðŸ“· Upload Photo";}
function ensureName(){const v=(nameEl.value||'').trim();if(!v){alert('Please enter a name for the poster.');nameEl.focus();return false;}return true;}
function wrapText(t,x,y,maxW,lineH){const w=t.split(' ');let l='';for(let n=0;n<w.length;n++){const test=l+w[n]+' ';if(ctx.measureText(test).width>maxW&&n>0){ctx.fillText(l,x,y);l=w[n]+' ';y+=lineH;}else l=test;}ctx.fillText(l,x,y);}

zoom.addEventListener('input',()=>{imageScale=parseFloat(zoom.value);zoomVal.textContent=imageScale.toFixed(2)+'Ã—';if(userImg)draw();});

function draw(){
 ctx.fillStyle='#efe2c4';ctx.fillRect(0,0,cvs.width,cvs.height);
 if(tpl.complete&&tpl.naturalWidth>0){ctx.globalAlpha=0.95;ctx.drawImage(tpl,0,0,cvs.width,cvs.height);ctx.globalAlpha=1;}
 ctx.fillStyle='#2b1708';ctx.textAlign='center';ctx.font='bold 98px Georgia,serif';ctx.fillText('WANTED',cvs.width/2,120);
 const name=(nameEl.value||'').trim();if(name){ctx.font='bold 36px Georgia,serif';ctx.fillText(name.toUpperCase(),cvs.width/2,170);}
 const pad=0.02*cvs.width;const box={x:cvs.width*0.12+pad,y:cvs.height*0.21+pad,w:cvs.width*0.76-2*pad,h:cvs.height*0.50-2*pad};
 ctx.strokeStyle='rgba(0,0,0,.45)';ctx.lineWidth=6;ctx.strokeRect(box.x-4,box.y-4,box.w+8,box.h+8);
 if(userImg){
   // CONTAIN fit, then user-controlled zoom
   const scale=Math.min(box.w/userImg.width, box.h/userImg.height)*imageScale;
   const w=userImg.width*scale, h=userImg.height*scale;
   const x=box.x+(box.w-w)/2, y=box.y+(box.h-h)/2;
   ctx.save();ctx.beginPath();ctx.rect(box.x,box.y,box.w,box.h);ctx.clip();ctx.drawImage(userImg,x,y,w,h);ctx.restore();
 }
 const crime='Crime: '+pick(crimes).toUpperCase();
 const reward='Reward: '+pick(rewards);
 ctx.font='bold 30px Georgia,serif';wrapText(crime,cvs.width/2,cvs.height-150,620,36);
 ctx.font='20px Georgia,serif';ctx.fillText(reward,cvs.width/2,cvs.height-60);
 dl.href=cvs.toDataURL('image/png');dl.style.display='inline-block';
}

tpl.onload=draw;

// Upload/file picker (now truly gives Upload / Take Photo / Browse on iPhone)
fileEl.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  setPhotoChosen(true); // mark immediately to avoid race
  const r=new FileReader();
  r.onload=ev=>{userImg=new Image();userImg.onload=()=>{draw();};userImg.src=ev.target.result;};
  r.readAsDataURL(f);
});

// Live camera
cameraBtn.addEventListener('click',async()=>{
  if(!navigator.mediaDevices?.getUserMedia){alert('Live camera not supported in this browser.');return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    video.srcObject=stream;
    document.getElementById('videoWrap').style.display='block';
    snapBtn.disabled=false;
    cameraBtn.textContent='Retake with Live Camera';
  }catch(e){alert('Could not access camera. If on iPhone, open the HTTPS site.');}
});

snapBtn.addEventListener('click',()=>{
  if(!stream) return;
  const tmp=document.createElement('canvas');
  tmp.width=video.videoWidth||1280; tmp.height=video.videoHeight||720;
  tmp.getContext('2d').drawImage(video,0,0);
  const img=new Image();
  img.onload=()=>{userImg=img; setPhotoChosen(true); draw();};
  img.src=tmp.toDataURL('image/png');
  // Stop stream and tidy UI
  stream.getTracks().forEach(t=>t.stop()); stream=null;
  document.getElementById('videoWrap').style.display='none';
  snapBtn.disabled=true;
  cameraBtn.textContent='Retake with Live Camera';
});

makeBtn.addEventListener('click',()=>{
  if(!ensureName()) return;
  if(!hasPhoto){ alert('Please upload or take a photo first.'); return; }
  draw();
});
</script>
</body>
</html>
