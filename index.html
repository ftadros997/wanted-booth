<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wanted Poster Booth</title>
<meta name="theme-color" content="#d7c49e">
<meta http-equiv="Cache-Control" content="no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{margin:0;font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;background:#f6f0e3;color:#222;}
  header{padding:16px;background:#f6f0e3;border-bottom:1px solid #decfae;}
  .container{max-width:1000px;margin:auto;padding:16px;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
  @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.1);}
  canvas{width:100%;max-width:480px;border:3px solid #654321;border-radius:8px;background:#efe2c4;}
  button,.btn{padding:10px 14px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer;font-weight:600;}
  button.secondary{background:#fff;color:#222;border:1px solid #aaa;}
  input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #bbb;width:100%;max-width:300px;}
  input[type=file]{display:none}
  .row{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0;align-items:center}
  .hint{font-size:.9rem;color:#6b5a46}
  .status{font-size:.85rem;padding:6px 10px;border-radius:999px;background:#efe2c4;border:1px solid #decfae;color:#5b4632}
  .ok{color:#0a6e2f}
</style>
<script>
// ðŸš« Kill any old Service Workers + caches so you don't see stale UI
(async () => {
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches && caches.keys) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
  } catch(e) {}
})();
</script>
</head>
<body>
<header><div class="container"><h2 style="margin:0">Wanted Poster Booth</h2></div></header>

<div class="container grid">
<section class="card">
  <h3>Create your poster</h3>
  <div class="row">
    <label for="name">Name:</label>
    <input id="name" type="text" placeholder="e.g. Sheriff Alex" maxlength="40">
  </div>

  <div class="row">
    <span class="status ok" id="photoStatus" style="display:none">Photo loaded âœ“</span>
  </div>

  <div class="row">
    <!-- Single input so iOS shows Photo Library / Take Photo / Browse in one sheet -->
    <button id="btnPick" class="secondary">Upload or Take Photo</button>
    <input id="filePick" type="file" accept="image/*">
  </div>

  <div class="row">
    <label for="zoom">Zoom:</label>
    <input id="zoom" type="range" min="0.6" max="1.4" step="0.01" value="0.85">
    <span id="zoomVal" class="hint">0.85Ã—</span>
  </div>

  <div class="row">
    <button id="makeBtn">Make Poster</button>
    <a id="dl" class="btn" style="display:none" download="wanted-poster.png">Download Poster</a>
  </div>

  <div class="row hint">
    â€¢ Tap <b>Upload or Take Photo</b>, then <b>Use Photo</b> â€” the poster renders automatically.
  </div>
</section>

<section class="card">
  <canvas id="c" width="768" height="1152" aria-label="Wanted poster preview"></canvas>
</section>
</div>

<script>
/* Safari toBlob polyfill */
if(!HTMLCanvasElement.prototype.toBlob){
  HTMLCanvasElement.prototype.toBlob=function(cb,type,quality){
    const dataURL=this.toDataURL(type,quality);
    const bin=atob(dataURL.split(',')[1]); const len=bin.length;
    const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i);
    cb(new Blob([arr],{type:type||'image/png'}));
  };
}

const cvs=document.getElementById('c'),ctx=cvs.getContext('2d');
const tpl=new Image();tpl.src='poster_template.png?cb=v10';

let userImg=null, userURL=null;
let imageScale=0.85;
let pickerOpened=false;

const nameEl=document.getElementById('name');
const btnPick=document.getElementById('btnPick');
const filePick=document.getElementById('filePick');
const zoom=document.getElementById('zoom'), zoomVal=document.getElementById('zoomVal');
const makeBtn=document.getElementById('makeBtn'), dl=document.getElementById('dl');
const photoStatus=document.getElementById('photoStatus');

const crimes=["Stole all the 3 AM burritos","Refused to share fries","Serial high-fiver","Guilty of excessive dad jokes","Pocketed the last donut","Liberating cake from a tiny box","Hijacked the office stapler","Dance-floor instigator","Coffee-cup thief","Snuck extra napkins"];
const rewards=["A bag of gold coins","A lifetime supply of tacos","A golden sheriff badge","Free donuts for a week","A mug of strong coffee","A comfy cowboy hat","Two front-row rodeo seats"];

function pick(a){return a[Math.floor(Math.random()*a.length)];}
function ensureName(){const v=(nameEl.value||'').trim();if(!v){alert('Please enter a name for the poster.');nameEl.focus();return false;}return true;}
function wrapText(t,x,y,maxW,lineH){const w=t.split(' ');let l='';for(let n=0;n<w.length;n++){const test=l+w[n]+' ';if(ctx.measureText(test).width>maxW&&n>0){ctx.fillText(l,x,y);l=w[n]+' ';y+=lineH;}else l=test;}ctx.fillText(l,x,y);}
function cleanupURL(){ if(userURL){URL.revokeObjectURL(userURL); userURL=null;} }
function showPhotoLoaded(){ photoStatus.style.display='inline-block'; setTimeout(()=>photoStatus.style.display='none', 2500); }

function handleFile(file){
  if(!file) return;
  cleanupURL();
  userURL = URL.createObjectURL(file);
  const img=new Image();
  img.onload=()=>{ userImg=img; draw(); showPhotoLoaded(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); };
  img.onerror=()=>{ alert('Could not load that file. Please try a different photo.'); };
  img.src=userURL;
}

btnPick.addEventListener('click',()=>{ filePick.value=''; pickerOpened=true; filePick.click(); });
filePick.addEventListener('change',e=>handleFile(e.target.files?.[0]));
filePick.addEventListener('input', e=>handleFile(e.target.files?.[0]));

// Fallback: if iOS drops events, harvest on focus/visibility
function tryHarvest(){ const i=filePick; if(i && i.files && i.files.length>0){ handleFile(i.files[0]); } }
document.addEventListener('visibilitychange',()=>{ if(!document.hidden && pickerOpened) setTimeout(tryHarvest,150); });
window.addEventListener('focus', ()=>{ if(pickerOpened) setTimeout(tryHarvest,150); });

function draw(){
  ctx.fillStyle='#efe2c4';ctx.fillRect(0,0,cvs.width,cvs.height);
  if(tpl.complete&&tpl.naturalWidth>0){ctx.globalAlpha=0.95;ctx.drawImage(tpl,0,0,cvs.width,cvs.height);ctx.globalAlpha=1;}
  ctx.fillStyle='#2b1708';ctx.textAlign='center';
  ctx.font='bold 98px Georgia,serif';ctx.fillText('WANTED',cvs.width/2,120);
  const name=(nameEl.value||'').trim(); if(name){ctx.font='bold 36px Georgia,serif';ctx.fillText(name.toUpperCase(),cvs.width/2,170);}
  const pad=0.025*cvs.width;
  const box={x:cvs.width*0.12+pad,y:cvs.height*0.21+pad,w:cvs.width*0.76-2*pad,h:cvs.height*0.48-2*pad};
  ctx.strokeStyle='rgba(0,0,0,.45)';ctx.lineWidth=6;ctx.strokeRect(box.x-4,box.y-4,box.w+8,box.h+8);
  if(userImg){
    const scale=Math.min(box.w/userImg.width, box.h/userImg.height)*imageScale;
    const w=userImg.width*scale, h=userImg.height*scale;
    const x=box.x+(box.w-w)/2, y=box.y+(box.h-h)/2;
    ctx.save();ctx.beginPath();ctx.rect(box.x,box.y,box.w,box.h);ctx.clip();
    ctx.drawImage(userImg,x,y,w,h);ctx.restore();
  }
  const crime='Crime: '+pick(crimes).toUpperCase();
  const reward='Reward: '+pick(rewards);
  ctx.font='bold 30px Georgia,serif';wrapText(crime,cvs.width/2,cvs.height-150,620,36);
  ctx.font='20px Georgia,serif';ctx.fillText(reward,cvs.width/2,cvs.height-60);
  dl.href=cvs.toDataURL('image/png'); dl.style.display='inline-block';
}

zoom.addEventListener('input',()=>{
  const v=parseFloat(zoom.value); imageScale=v; zoomVal.textContent=v.toFixed(2)+'Ã—';
  if(userImg) draw();
});

makeBtn.addEventListener('click',()=>{
  const name=(nameEl.value||'').trim();
  if(!name){ alert('Please enter a name for the poster.'); nameEl.focus(); return; }
  if(!userImg){ alert('Please upload or take a photo first.'); return; }
  draw();
});

tpl.onload=draw;
</script>
</body>
</html>
